---
title: 关于sql执行计划
categories: 数据库
keywords: 'sql,执行计划'
abbrlink: 60f024c8
date: 2021-11-08 16:54:09
tags: 
 - 数据库
 - 执行计划
--- 

最近受到客服的一个反馈:某个功能长时间无反馈,响应时间达到了`20s`以上,通过调用日志发现,某条`sql`查询竟然花费了`12s`的时间,而且查询了两次,于是准备通过执行计划对此进行找方向调优.

# 什么是执行计划

## 1. `MySQL`逻辑结构先知
<!-- more -->

关于`MySQL`的逻辑结构，将其理解为四层，就像项目分层一样，每一层处理不同的业务逻辑，先看图后说话：

{% asset_img 2021-11-17-15-24-30.png %}

上图概述：

- 客户端：这里指连接`MySQL`各种形式，如`.Net`中使用的`ADO`连接、`Java`使用`JDBC`连接等；`MySQL`是客户端和服务器模式，前提先建立连接，才能传输数据，处理相关逻辑；

- 业务逻辑：在`MySQL`内部有很多模块组成，分别处理相关业务逻辑；

- 连接管理：负责连接认证、连接数判断、连接池处理等业务逻辑处理；

- 查询缓存：当一个`SQL`进来时，如果开启查询缓存功能，`MySQL`会优先去查询缓存中检查是否有数据匹配，如果匹配上，就不会再去解析对应的`SQL`啦，但如果语句中有用户自定义函数、存储函数、用户变量、临时表、`mysql`库中的系统表时，都不会走缓存； 对于查询缓存来说，在`MySQL8.0`已经去除，官方回应的是在一定场景上，查询缓存会导致性能上的瓶颈。

- 解析器：对于一个`SQL`语句，`MySql`根据语法规则需要对其进行解析，并生成一个内部能识别的解析树；

- 优化器：负责对解析器得到的解析树进行优化，`MySQL`会根据内部算法找到一个`MySQL`认为最优的执行计划，后续就按照这个执行计划执行。所以后续我们分析的就是`MySQL`针对`SQL`语句选择出来的最优执行计划，结合业务，根据规则对`SQL`进行优化，从而让`SQL`语句在`MySQL`内部达到真正的最优。

- 执行器：得到执行计划之后，就会找到对应的存储引擎，根据执行计划给出的指令依次执行。

- 存储引擎：数据的存储和提取最后是靠存储引擎；`MySQL`内部实现可插拔式的存储引擎机制，不同的存储引擎执行不同的逻辑；

- 物理文件：数据存储的最终位置，即磁盘上；协同存储引擎对数据进行读写操作。

关于`MySql`的逻辑结构，以上只是简单描述，业务逻辑层的功能模块远不止上面提到的，小伙伴有兴趣可以专门研究一下，这里的目的就是为了体现`SQL`语句到服务器上时经过的几个关键步骤，方便后续优化的理解。

## 2.`SQL`语句的中关键字执行顺序须知

在编写一条查询语句时，习惯性的从头到尾开始敲出来，应该都是从`select` 开始吧，但似乎没太注意它们真正的执行顺序；既然要优化，肯定需要得知道一条`SQL`语句大概的执行流程，结合执行计划，目的就更加清晰啦；上一张一看就明白的图：


