---
title: 工作难点
hide: true
abbrlink: d0966c4d
date: 2022-03-24 20:39:16
tags:
categories:
keywords:
---

## 索引失效的原因

发票项目当初查询列表时queryInvoicesForCom接口，该接口主要用来列表发票信息的，当时是因为业务反应前端很久才会有显示，然后当时我来优化


主要的耗时点是在一条sql上，老sql遗留问题，由于当初在设计t_invoice表的时候，是一条记录进行作用的，所以查询的时候，需要进行拆分 operate，通过状态进行拆分、

sql语句是 union all 


explain 执行计划下来 type中有all全扫描，应该是没有击中索引，其实常见的未击中索引我都有去考虑过，

where 中使用 != 或 <> 或 or 或表达式或函数（左侧）
like 语句 % 开头
字符串未加’’
索引字段区分度过低，如性别
未匹配最左前缀




一点点的抽丝剥茧，也问了很多同事，身边的架构师，讲道理来说是会命中索引的，应该是mysql自己优化成不走索引了，线上数据目前是800w左右，时间区间是三个月，数据量过于大的时候，就会不走索引
所以这也是急需要优化的点，加上mybatis会查询两次，时间就进行了翻倍，
执行计划一条type为ref rows属性达到了100w，所以数据量
所以需要删除一些历史遗留的merchantID，以及缩小时间区间看看是否能够优化，因为在测试环境是可以走通的，测试环境的话只有几十万，所以都是没有问题的，最后原因如果数据量过大的话，也不会一定走索引，所以这个时候只能多加限制了。。。。


各属性含义：
id：查询的序列号

select_type：查询的类型，主要是区别普通查询和联合查询、子查询之类的复杂查询

SIMPLE：查询中不包含子查询或者UNION
查询中若包含任何复杂的子部分，最外层查询则被标记为：PRIMARY
在SELECT或WHERE列表中包含了子查询，该子查询被标记为：SUBQUERY
table：输出的行所引用的表

type：访问类型

从左至右，性能由差到好

ALL：扫描全表
index：扫描全部索引树
range：扫描部分索引，索引范围扫描，对索引的扫描开始于某一点，返回匹配值域的行，常见于between、<、>等的查询
ref：使用非唯一索引或非唯一索引前缀进行的查找
（eq_ref和const的区别：）
eq_ref：唯一性索引扫描，对于每个索引键，表中只有一条记录与之匹配。常见于主键或唯一索引扫描
const：单表中最多有一个匹配行，查询起来非常迅速，例如根据主键或唯一索引查询。
system：system是const类型的特例，当查询的表只有一行的情况下， 使用system。
NULL：不用访问表或者索引，直接就能得到结果，如select 1 from test where 1
possible_keys：表示查询时可能使用的索引。如果是空的，没有相关的索引。这时要提高性能，可通过检验WHERE子句，看是否引用某些字段，或者检查字段不是适合索引。

key：显示MySQL实际决定使用的索引。如果没有索引被选择，是NULL

key_len：使用到索引字段的长度
注：key_len显示的值为索引字段的最大可能长度，并非实际使用长度，即key_len是根据表定义计算而得，不是通过表内检索出的。

ref：显示哪个字段或常数与key一起被使用

rows：这个数表示mysql要遍历多少数据才能找到，表示MySQL根据表统计信息及索引选用情况，估算的找到所需的记录所需要读取的行数，在innodb上可能是不准确的

Extra：执行情况的说明和描述。包含不适合在其他列中显示但十分重要的额外信息。

Using index：表示使用索引，如果只有 Using index，说明他没有查询到数据表，只用索引表就完成了这个查询，这个叫覆盖索引。

Using where：表示条件查询，如果不读取表的所有数据，或不是仅仅通过索引就可以获取所有需要的数据，则会出现 Using where。


查询条件中IS NULL，当命中结果数量小于40%的时候，会走索引。

查询条件中的IS NOT NULL,命中结果数小于30%的时候，会走索引。

## 当初对账项目找不到mapper文件的原因（多数据源引起）


其实这个问题是当初开发日清算的时候有的，其实这个问题是因为多数据源引起的，多数据源primary注解，多数据源时会逐步扫描config包下的config文件，读取config文件时，当时项目的分层出现了严重的问题，不同数据源需要
不同的包进行隔离，但是但是主数据源就卸载了dao下，但是另一个副数据源缺新建了包，这个问题呢，很巧的是本地环境不会有问题，开发和测试环境出现过一次但是生产环境就会一直报错。。。





## 文件上传前端超时的问题如何解决

有一个上传的需求需要上传1000个司机，但是由于是同步操作



## 在同一个事务中调用服务的另一个方法引起的问题（司机离职）









